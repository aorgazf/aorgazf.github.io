<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "https:\/\/www.alvaroorgaz.com\/"
        },
        "articleSection" : "post",
        "name" : "Credential Switcher",
        "headline" : "Credential Switcher",
        "description" : "\x3cp\x3eA PowerShell script to easily switch between credentials to access a SMB network share.\x3c\/p\x3e",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2019",
        "datePublished": "2019-10-06 21:08:33 \x2b0530 \x2b0530",
        "dateModified" : "2019-10-06 21:08:33 \x2b0530 \x2b0530",
        "url" : "https:\/\/www.alvaroorgaz.com\/post\/credentialswitcher\/",
        "wordCount" : "1339",
        "image" : "https://www.alvaroorgaz.com//img/Software-Engineering-2.jpg"",
        "keywords" : [ ""Ransomware"",""PowerShell"","Blog" ]   
    }
    </script>


 <title>Credential Switcher </title>


<meta name="description" content="Álvaro Orgaz Cybersecurity Projects Portfolio" />



<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="https://fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

<link href="https://www.alvaroorgaz.com/css/style.css?v=1570385275" rel="stylesheet" id="theme-stylesheet" type='text/css' media='all'>

<link href="https://www.alvaroorgaz.com/css/custom.css?v=1570385275" rel="stylesheet" type='text/css' media='all'>
<link rel="shortcut icon" href="https://www.alvaroorgaz.com/img/favicon.ico" type="image/x-icon">
<link rel="icon" href="https://www.alvaroorgaz.com/img/favicon.ico" type="image/x-icon">


</head>


<body class="post-template-default single single-post single-format-standard ct-body singular singular-post not-front standard">

  <div id="overflow-container" class="overflow-container">
    <a class="skip-content" href="#main">Skip to content</a>
    <header id="site-header" class="site-header" role="banner">
      <div class='top-navigation'>
        <div class='container'>

  <div id="menu-secondary" class="menu-container menu-secondary" role="navigation">
    <button id="toggle-secondary-navigation" class="toggle-secondary-navigation"><i class="fas fa-plus"></i></button>

    <div class="menu">

      <ul id="menu-secondary-items" class="menu-secondary-items">
        
        <li class="menu-item menu-item-type-taxonomy menu-item-object-category">
          <a href="/categories/cybersecurity">cybersecurity</a>
        </li>
        

      </ul>

    </div>

  </div>


  <ul class="social-media-icons">


    

    

    

    

    

    
    <li>
      <a href="https://www.linkedin.com/in/alvaroorgaz" data-animate-hover="pulse" class="linkedin" target="_blank">
        <i class="fab fa-linkedin-in" title="linkedin"></i>
        <span class="screen-reader-text">linkedin</span>
      </a>
    </li>
    

    


    
    <li>
      <a href="https://github.com/aorgazf" data-animate-hover="pulse" class="github" target="_blank">
        <i class="fab fa-github" title="github"></i>
        <span class="screen-reader-text">github</span>
      </a>
    </li>
    


    

    


  </ul></div>

      </div>

      <div class="container">
        <div id="title-info" class="title-info">
  <div id='site-title' class='site-title'>
    
    <a href="/"> Álvaro Orgaz </a>
    </div>
  </div>
  <button id="toggle-navigation" class="toggle-navigation">
    <i class="fas fa-bars"></i>
  </button>

  <div id="menu-primary-tracks" class="menu-primary-tracks"></div>
  <div id="menu-primary" class="menu-container menu-primary" role="navigation">
    
    <p class="site-description">CISSP PMP</p>
    

    <div class="menu">
      <ul id="menu-primary-items" class="menu-primary-items">
        
        
        <li class='menu-item menu-item-type-custom menu-item-object-custom '>
          <a href="https://www.alvaroorgaz.com/">Home</a>
          
        </li>
        
        <li class='menu-item menu-item-type-post_type menu-item-object-page '>
          <a href="https://www.alvaroorgaz.com/about/">About</a>
          
        </li>
        
      </ul>
    </div>

  </div>

      </div>
    </header>

    <div id="main" class="main" role="main">

      
  
  
    
  
  
  <div id="loop-container" class="loop-container">
    
    <div class="post type-post status-publish format-standard has-post-thumbnail hentry category-design tag-design tag-standard-2 tag-tagalicious tag-travel entry full-without-featured odd excerpt-1">

      <div class='featured-image lazy lazy-bg-image'  data-background="https://www.alvaroorgaz.com/img/Software-Engineering-2.jpg">
      </div>
      
        <div class="entry-meta">
          <span class="date">06 October</span>	<span> / </span>

          <span class="author">
            <a href="https://www.alvaroorgaz.com/" title="Posts by Alvaro Orgaz" rel="author">Alvaro Orgaz</a>
          </span>


          
          <span class="category">
            <span> / </span>

            <a href="/categories/cybersecurity">Cybersecurity</a>
          </span>
          


        </div>
        <div class='entry-header'>
          <h1 class='entry-title'> Credential Switcher</h1>
        </div>
        <div class="entry-container">
          <div class="entry-content">
            <article>
              <p>A PowerShell script to easily switch between credentials to access a SMB network share.</p>

<h3 id="the-problem">The problem</h3>

<p>The number of <strong>ransomware</strong> attacks is on the rise as it is proving to be a very profitable activity. When a computer is infected with ransomware, it starts to encrypt all files in the local computer and on the network to cause as much damage as possible.</p>

<p>In many personal and business environments users access information stored on shared network folders. These folders usually serve as repositories of files. The more data these folders contain, the more valuable they become.</p>

<p>The best protection against ransomware is to ensure any valuable data is being backed up on a regular basis both locally and on the cloud. An <strong>additional layer of protection</strong> to minimise the damage that malware could cause if it were to gain access to a computer, we should apply the principle of <strong>least privilege</strong>, restricting the access rights of users to just those absolutely required.</p>

<p>Most of the time users don&rsquo;t require full read and write permissions when accessing repositories; they only require writing permissions when they need to save file changes or when they need to reorganise the repository.</p>

<p>In the same way that it is best practice not to grant users with admin rights on their computer accounts for their daily tasks, it would be desirable to grant network users only with reading access to repositories and provide them with <strong>separate credentials with writing permissions</strong> for when they need to do so.</p>

<p>Unfortunately Windows does not provide a simple mechanism to implement this. When Windows connects to a network share using SMB protocol, it establishes a SMB session using the credentials saved or provided when the connection is established. But Windows implementation of the protocol does not allow multiple concurrent connections to the same resource with different credentials.</p>

<p>Attempting to establish a new connection with different credentials results in the following error:</p>

<p><img src="https://raw.githubusercontent.com/aorgazf/credential-switcher/master/img/error%201219%20w.png" alt="error 1219 w" /></p>

<p>Using the <code>net use</code> command renders the same results:</p>

<p><img src="https://raw.githubusercontent.com/aorgazf/credential-switcher/master/img/error%201219.png" alt="error 1219" /></p>

<p>The <code>get-smbconnection</code> cmdlet shows that there were already connections established under another username:</p>

<p><img src="https://raw.githubusercontent.com/aorgazf/credential-switcher/master/img/get-smbconnection_alvaro.png" alt="get-smbconnection.png" /></p>

<p>In order to establish a new connection with different credentials all current SMB connections need to be closed first, but Windows does not provide a simple mechanism to close those open connections and switch credentials.</p>

<h3 id="the-solution">The solution</h3>

<p>A simple PowerShell script that allows the user to temporarily switch to use different credentials with higher permissions to carry out specific tasks and reverts back to the original credentials automatically after some time or once the user confirms the task is completed.</p>

<p>Windows <code>net use</code> command can be used to connect to network folders, however <code>net use /delete</code> does not close the opened SMB connections. The following screenshot shows the results of  <code>Get-SmbConnection</code> cmdlet confirming that there are lingering connections after the use of <code>net use /delete</code>.</p>

<p><img src="https://raw.githubusercontent.com/aorgazf/credential-switcher/master/img/.png" alt=".png" /></p>

<p>After some research, the best method to ensure the connections are closed is to disable the network adapter through which they were created. This method works better than the alternative of restarting Windows Explorer process. The downside is that disabling and re-enabling a network adapter requires administrator privileges.</p>

<p>That on its own is not a problem, but the commands to connect to a network share and to store user&rsquo;s credentials need to be run in the context of the user.</p>

<p>For this reason the script is divided in two modules: Server and Client</p>

<h4 id="credential-switcher-server">Credential Switcher Server</h4>

<p>The Server module is meant to be run under administrator privileges when the computer is turned on. Its main purpose is to reset (disable and re-enable) the network adapter in order to close any lingering SMB connections.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Action - Reset Network Adapter</span>
<span style="color:#111">$NetworkAdapter</span> <span style="color:#111">=</span> <span style="color:#d88200">&#39;Ethernet&#39;</span>
<span style="color:#00a8c8">Function</span> <span style="color:#111">ResetNetworkAdapter</span> <span style="color:#111">{</span>
    <span style="color:#111">Disable-NetAdapter</span> <span style="color:#111">-Name</span> <span style="color:#111">$NetworkAdapter</span> <span style="color:#111">-Confirm</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$false</span>
    <span style="color:#00a8c8">do</span> <span style="color:#111">{}</span> <span style="color:#00a8c8">while</span> <span style="color:#111">((</span><span style="color:#111">Get-NetAdapter</span> <span style="color:#111">$NetworkAdapter</span><span style="color:#111">).</span><span style="color:#111">Status</span> <span style="color:#f92672">-ne</span> <span style="color:#d88200">&#34;Disabled&#34;</span><span style="color:#111">)</span>
    <span style="color:#111">Enable-NetAdapter</span> <span style="color:#111">-Name</span> <span style="color:#111">$NetworkAdapter</span> <span style="color:#111">-Confirm</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$false</span>
    <span style="color:#00a8c8">do</span> <span style="color:#111">{}</span> <span style="color:#00a8c8">while</span> <span style="color:#111">((</span><span style="color:#111">Get-NetAdapter</span> <span style="color:#111">$NetworkAdapter</span><span style="color:#111">).</span><span style="color:#111">Status</span> <span style="color:#f92672">-ne</span> <span style="color:#d88200">&#34;Up&#34;</span><span style="color:#111">)</span>
    <span style="color:#111">$NotifyIcon</span><span style="color:#111">.</span><span style="color:#111">ShowBalloonTip</span><span style="color:#111">(</span><span style="color:#111">30000</span><span style="color:#111">,</span><span style="color:#d88200">&#34;Attention!&#34;</span><span style="color:#111">,</span><span style="color:#d88200">&#34;Network Adapter Reset&#34;</span><span style="color:#111">,</span><span style="color:#00a8c8">[system.windows.forms.ToolTipIcon]</span><span style="color:#d88200">&#34;Warning&#34;</span><span style="color:#111">)</span>
<span style="color:#111">}</span></code></pre></div>
<p>The module also provides a nice user interface to configure its settings and exit.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Notification Icon</span>
<span style="color:#00a8c8">[void][System.Reflection.Assembly]</span><span style="color:#111">::</span><span style="color:#111">LoadWithPartialName</span><span style="color:#111">(</span><span style="color:#d88200">&#34;System.windows.forms&#34;</span><span style="color:#111">)</span>

<span style="color:#111">$MainForm</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Windows</span><span style="color:#111">.</span><span style="color:#111">Forms</span><span style="color:#111">.</span><span style="color:#111">form</span>
<span style="color:#111">$NotifyIcon</span><span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Windows</span><span style="color:#111">.</span><span style="color:#111">Forms</span><span style="color:#111">.</span><span style="color:#111">NotifyIcon</span>
<span style="color:#111">$ContextMenu</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Windows</span><span style="color:#111">.</span><span style="color:#111">Forms</span><span style="color:#111">.</span><span style="color:#111">ContextMenu</span>

<span style="color:#111">$TimerRoutine</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Windows</span><span style="color:#111">.</span><span style="color:#111">Forms</span><span style="color:#111">.</span><span style="color:#111">Timer</span>
<span style="color:#111">$TimerSessionTimeOut</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Windows</span><span style="color:#111">.</span><span style="color:#111">Forms</span><span style="color:#111">.</span><span style="color:#111">Timer</span>
<span style="color:#111">$iconWarn</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Drawing</span><span style="color:#111">.</span><span style="color:#111">Icon</span><span style="color:#111">(</span><span style="color:#d88200">&#34;$PSScriptRoot\Warning.ico&#34;</span><span style="color:#111">)</span>

<span style="color:#111">$MainForm</span><span style="color:#111">.</span><span style="color:#111">ShowInTaskbar</span> <span style="color:#111">=</span> <span style="color:#111">$false</span>
<span style="color:#111">$MainForm</span><span style="color:#111">.</span><span style="color:#111">WindowState</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;minimized&#34;</span>

<span style="color:#111">$NotifyIcon</span><span style="color:#111">.</span><span style="color:#111">Icon</span> <span style="color:#111">=</span>  <span style="color:#111">$iconWarn</span>
<span style="color:#111">$NotifyIcon</span><span style="color:#111">.</span><span style="color:#111">Text</span> <span style="color:#111">=</span> <span style="color:#d88200">&#34;&#34;</span>
<span style="color:#111">$NotifyIcon</span><span style="color:#111">.</span><span style="color:#111">ContextMenu</span> <span style="color:#111">=</span> <span style="color:#111">$ContextMenu</span>
<span style="color:#111">$NotifyIcon</span><span style="color:#111">.</span><span style="color:#111">Visible</span> <span style="color:#111">=</span> <span style="color:#111">$True</span></code></pre></div>
<p>The server launches a TCP Listener on a separate thread and waits for a client to issue instructions:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Launch TCP Listener and wait for commands</span>
 <span style="color:#111">$scriptblock</span> <span style="color:#111">=</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">param</span><span style="color:#111">(</span><span style="color:#111">$addr</span><span style="color:#111">,</span> <span style="color:#111">$port</span><span style="color:#111">)</span> 
    <span style="color:#75715e"># $addr = [ipaddress]&#39;127.0.0.1&#39;;$port = 1235</span>
    <span style="color:#111">$endpoint</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">Net</span><span style="color:#111">.</span><span style="color:#111">IPEndPoint</span> <span style="color:#111">(</span><span style="color:#111">$addr</span><span style="color:#111">,</span> <span style="color:#111">$port</span><span style="color:#111">)</span>
    <span style="color:#111">$server</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">Net</span><span style="color:#111">.</span><span style="color:#111">Sockets</span><span style="color:#111">.</span><span style="color:#111">TcpListener</span> <span style="color:#111">$endpoint</span>

    <span style="color:#111">$exiting</span> <span style="color:#111">=</span> <span style="color:#111">$False</span>
    <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#f92672">-not</span> <span style="color:#111">$exiting</span><span style="color:#111">){</span>
        <span style="color:#111">$server</span><span style="color:#111">.</span><span style="color:#111">Start</span><span style="color:#111">()</span>
        <span style="color:#111">Write-Output</span> <span style="color:#d88200">&#34;Listening&#34;</span>
        <span style="color:#111">$client</span> <span style="color:#111">=</span> <span style="color:#111">$server</span><span style="color:#111">.</span><span style="color:#111">AcceptTcpClient</span><span style="color:#111">()</span>
        <span style="color:#111">$client</span><span style="color:#111">.</span><span style="color:#111">ReceiveTimeout</span><span style="color:#111">=</span> <span style="color:#111">1000</span>
        <span style="color:#75715e"># [Console]::beep(1000,300)</span>
        <span style="color:#111">$stream</span> <span style="color:#111">=</span> <span style="color:#111">$client</span><span style="color:#111">.</span><span style="color:#111">GetStream</span><span style="color:#111">()</span>
        <span style="color:#111">$reader</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">IO</span><span style="color:#111">.</span><span style="color:#111">StreamReader</span><span style="color:#111">(</span><span style="color:#111">$stream</span><span style="color:#111">)</span>
        <span style="color:#111">$writer</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">IO</span><span style="color:#111">.</span><span style="color:#111">StreamWriter</span><span style="color:#111">(</span><span style="color:#111">$stream</span><span style="color:#111">)</span>
        <span style="color:#111">$writer</span><span style="color:#111">.</span><span style="color:#111">AutoFlush</span> <span style="color:#111">=</span> <span style="color:#111">$true</span>
        <span style="color:#111">Write-Output</span> <span style="color:#d88200">&#34;Client_Connected&#34;</span>
        <span style="color:#111">$timeouts</span> <span style="color:#111">=</span> <span style="color:#111">0</span>
        <span style="color:#111">$client_disconnected</span> <span style="color:#111">=</span> <span style="color:#111">$false</span>
        <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#f92672">-not</span> <span style="color:#111">$client_disconnected</span><span style="color:#111">)</span> <span style="color:#111">{</span>
            <span style="color:#00a8c8">Try</span><span style="color:#111">{</span>
                <span style="color:#111">$command</span> <span style="color:#111">=</span> <span style="color:#111">$reader</span><span style="color:#111">.</span><span style="color:#111">ReadLine</span><span style="color:#111">()</span>
                <span style="color:#00a8c8">switch</span> <span style="color:#111">(</span><span style="color:#111">$command</span><span style="color:#111">)</span> <span style="color:#111">{</span>
                <span style="color:#d88200">&#39;EXIT&#39;</span>  <span style="color:#111">{</span> <span style="color:#111">$exiting</span> <span style="color:#111">=</span> <span style="color:#111">$True</span><span style="color:#111">;</span> <span style="color:#00a8c8">break</span><span style="color:#111">}</span>
                <span style="color:#d88200">&#39;PING&#39;</span>  <span style="color:#111">{</span> <span style="color:#111">$writer</span><span style="color:#111">.</span><span style="color:#111">WriteLine</span><span style="color:#111">(</span><span style="color:#d88200">&#34;PONG&#34;</span><span style="color:#111">)}</span>
                <span style="color:#111">}</span>
                <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">$command</span> <span style="color:#f92672">-ne</span> <span style="color:#d88200">&#39;PING&#39;</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">Write-Output</span> <span style="color:#111">$command</span><span style="color:#111">}</span>

            <span style="color:#111">}</span> <span style="color:#00a8c8">Catch</span> <span style="color:#111">{</span><span style="color:#111">$command</span> <span style="color:#111">=</span> <span style="color:#111">$null</span><span style="color:#111">}</span>
            <span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">$command</span> <span style="color:#f92672">-eq</span> <span style="color:#111">$null</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">$timeouts</span> <span style="color:#111">=</span> <span style="color:#111">$timeouts</span> <span style="color:#111">+</span><span style="color:#111">1</span><span style="color:#111">;</span><span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">$timeouts</span> <span style="color:#f92672">-ge</span> <span style="color:#111">3</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#111">$client_disconnected</span> <span style="color:#111">=</span> <span style="color:#111">$true</span><span style="color:#111">;</span> <span style="color:#00a8c8">break</span><span style="color:#111">}}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span><span style="color:#111">$timeouts</span> <span style="color:#111">=</span> <span style="color:#111">0</span><span style="color:#111">}</span>
            <span style="color:#111">Start-Sleep</span> <span style="color:#111">-Seconds</span> <span style="color:#111">1</span>
        <span style="color:#111">}</span>
        <span style="color:#111">Write-Output</span> <span style="color:#d88200">&#34;Client_Disconnected&#34;</span>
        <span style="color:#111">$writer</span><span style="color:#111">.</span><span style="color:#111">Dispose</span><span style="color:#111">();</span> <span style="color:#111">$writer</span> <span style="color:#111">=</span> <span style="color:#111">$null</span>
        <span style="color:#111">$reader</span><span style="color:#111">.</span><span style="color:#111">Dispose</span><span style="color:#111">();</span> <span style="color:#111">$reader</span> <span style="color:#111">=</span> <span style="color:#111">$null</span>
        <span style="color:#111">$stream</span><span style="color:#111">.</span><span style="color:#111">Dispose</span><span style="color:#111">();</span> <span style="color:#111">$stream</span> <span style="color:#111">=</span> <span style="color:#111">$null</span>
        <span style="color:#111">$client</span><span style="color:#111">.</span><span style="color:#111">Dispose</span><span style="color:#111">();</span> <span style="color:#111">$client</span> <span style="color:#111">=</span> <span style="color:#111">$null</span>
        <span style="color:#111">Start-Sleep</span> <span style="color:#111">-Seconds</span> <span style="color:#111">1</span>
    <span style="color:#111">}</span>
    <span style="color:#111">$server</span><span style="color:#111">.</span><span style="color:#111">stop</span><span style="color:#111">()</span>
<span style="color:#111">}</span>

<span style="color:#111">$job</span> <span style="color:#111">=</span> <span style="color:#111">Start-Job</span> <span style="color:#111">-ScriptBlock</span> <span style="color:#111">$scriptblock</span> <span style="color:#111">-args</span> <span style="color:#111">$addr</span><span style="color:#111">,</span> <span style="color:#111">$port</span></code></pre></div>
<h4 id="credential-switcher-client">Credential Switcher Client</h4>

<p>The Client on the other hand checks there are valid credentials saved, asks for a PIN that is used to decrypt the safely stored credentials before switching.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># If credentials were not saved (or if they have expired), ask user for privileged and unprivileged credentials, encrypt them and save them</span>
<span style="color:#111">$ValidCredentials</span> <span style="color:#111">=</span> <span style="color:#111">$false</span>
<span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#111">Test-Path</span> <span style="color:#111">-Path</span> <span style="color:#111">$CredentialsFilePath</span><span style="color:#111">)</span> <span style="color:#111">{</span><span style="color:#00a8c8">if</span> <span style="color:#111">((</span><span style="color:#111">Get-Item</span> <span style="color:#111">$CredentialsFilePath</span><span style="color:#111">).</span><span style="color:#111">LastWriteTime</span><span style="color:#111">.</span><span style="color:#111">AddDays</span><span style="color:#111">(</span><span style="color:#111">$CredentialsValidityPeriod</span><span style="color:#111">)</span> <span style="color:#f92672">-gt</span> <span style="color:#111">$Today</span><span style="color:#111">)</span> <span style="color:#111">{</span> <span style="color:#111">$ValidCredentials</span><span style="color:#111">=</span><span style="color:#111">$true</span><span style="color:#111">}}</span>
<span style="color:#00a8c8">if</span> <span style="color:#111">(</span><span style="color:#f92672">-not</span><span style="color:#111">(</span><span style="color:#111">$ValidCredentials</span><span style="color:#111">))</span> <span style="color:#111">{</span>  
    <span style="color:#75715e">#Ask user for credentials</span>
    <span style="color:#111">$PrivilegedCredentials</span> <span style="color:#111">=</span> <span style="color:#111">$host</span><span style="color:#111">.</span><span style="color:#111">ui</span><span style="color:#111">.</span><span style="color:#111">PromptForCredential</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Privileged Credentials&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Please enter password&#34;</span><span style="color:#111">,</span> <span style="color:#111">$PrivilegedCredentialsUsername</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">)</span>
    <span style="color:#111">$UnprivilegedCredentials</span> <span style="color:#111">=</span> <span style="color:#111">$host</span><span style="color:#111">.</span><span style="color:#111">ui</span><span style="color:#111">.</span><span style="color:#111">PromptForCredential</span><span style="color:#111">(</span><span style="color:#d88200">&#34;Unprivileged Credentials&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;Please enter password&#34;</span><span style="color:#111">,</span> <span style="color:#111">$UnprivilegedCredentialsUsername</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">)</span>

    <span style="color:#75715e">#Ask use to set a Passcode</span>
    <span style="color:#111">$KeySS</span> <span style="color:#111">=</span>  <span style="color:#111">Read-Host</span> <span style="color:#d88200">&#34;Please set Passcode&#34;</span> <span style="color:#111">-asSecureString</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">((</span><span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">Length</span> <span style="color:#f92672">-lt</span> <span style="color:#111">$MinimumPinSize</span><span style="color:#111">)</span> <span style="color:#f92672">-or</span> <span style="color:#111">(</span><span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">Length</span> <span style="color:#f92672">-gt</span> <span style="color:#111">16</span><span style="color:#111">))</span> <span style="color:#111">{</span>
        <span style="color:#111">Write-Host</span> <span style="color:#d88200">&#34;Pin must be between $MinimumPinSize to 16 characters long&#34;</span>
        <span style="color:#111">Exit</span>
    <span style="color:#111">}</span>
    
    <span style="color:#75715e">#Pad key up to 16 bytes long</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">(</span><span style="color:#111">$i</span><span style="color:#111">=</span><span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">Length</span><span style="color:#111">;</span> <span style="color:#111">$i</span> <span style="color:#f92672">-lt</span> <span style="color:#111">16</span><span style="color:#111">;</span> <span style="color:#111">$i</span><span style="color:#111">++)</span> <span style="color:#111">{</span>
        <span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">AppendChar</span><span style="color:#111">(</span><span style="color:#00a8c8">[char]</span><span style="color:#111">32</span><span style="color:#111">)</span>
    <span style="color:#111">}</span>    

    <span style="color:#111">$EncryptedPrivileged</span> <span style="color:#111">=</span> <span style="color:#111">ConvertFrom-SecureString</span> <span style="color:#111">-SecureString</span> <span style="color:#111">$PrivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">Password</span> <span style="color:#111">-SecureKey</span> <span style="color:#111">$KeySS</span>
    <span style="color:#111">$EncryptedUnprivileged</span> <span style="color:#111">=</span> <span style="color:#111">ConvertFrom-SecureString</span> <span style="color:#111">-SecureString</span> <span style="color:#111">$UnprivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">Password</span> <span style="color:#111">-SecureKey</span> <span style="color:#111">$KeySS</span>

    <span style="color:#111">Write-Host</span> <span style="color:#111">$EncryptedPrivileged</span><span style="color:#111">.</span><span style="color:#111">Length</span>
    <span style="color:#111">Write-Host</span> <span style="color:#111">$EncryptedUnprivileged</span><span style="color:#111">.</span><span style="color:#111">Length</span>

    <span style="color:#111">New-Item</span> <span style="color:#111">-Path</span> <span style="color:#111">$CredentialsFilePath</span> <span style="color:#111">-ItemType</span> <span style="color:#d88200">&#34;file&#34;</span> <span style="color:#111">-Value</span> <span style="color:#d88200">&#34;$EncryptedPrivileged</span><span style="color:#8045ff">`r`n</span><span style="color:#d88200">&#34;</span> <span style="color:#111">-Force</span>
    <span style="color:#111">Add-Content</span> <span style="color:#111">-Path</span> <span style="color:#111">$CredentialsFilePath</span> <span style="color:#111">-Value</span> <span style="color:#111">$EncryptedUnprivileged</span> <span style="color:#111">-Force</span>

    <span style="color:#111">Write-Host</span> <span style="color:#d88200">&#34;Credentials saved to $CredentialsFilePath&#34;</span>
<span style="color:#111">}</span> <span style="color:#00a8c8">else</span> <span style="color:#111">{</span>
    <span style="color:#75715e"># Ask for Passcode, Decrypt and Mount</span>
    <span style="color:#111">$KeySS</span> <span style="color:#111">=</span>  <span style="color:#111">Read-Host</span> <span style="color:#d88200">&#34;Please enter Passcode&#34;</span> <span style="color:#111">-asSecureString</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">((</span><span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">Length</span> <span style="color:#f92672">-lt</span> <span style="color:#111">$MinimumPinSize</span><span style="color:#111">)</span> <span style="color:#f92672">-or</span> <span style="color:#111">(</span><span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">Length</span> <span style="color:#f92672">-gt</span> <span style="color:#111">16</span><span style="color:#111">))</span> <span style="color:#111">{</span>
        <span style="color:#111">Write-Host</span> <span style="color:#d88200">&#34;Pin must be between $MinimumPinSize to 16 characters long&#34;</span>
        <span style="color:#111">Exit</span>
    <span style="color:#111">}</span>
    
    <span style="color:#75715e">#Pad key up to 16 bytes long</span>
    <span style="color:#00a8c8">for</span> <span style="color:#111">(</span><span style="color:#111">$i</span><span style="color:#111">=</span><span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">Length</span><span style="color:#111">;</span> <span style="color:#111">$i</span> <span style="color:#f92672">-lt</span> <span style="color:#111">16</span><span style="color:#111">;</span> <span style="color:#111">$i</span><span style="color:#111">++)</span> <span style="color:#111">{</span>
        <span style="color:#111">$KeySS</span><span style="color:#111">.</span><span style="color:#111">AppendChar</span><span style="color:#111">(</span><span style="color:#00a8c8">[char]</span><span style="color:#111">32</span><span style="color:#111">)</span>
    <span style="color:#111">}</span>   

    <span style="color:#111">(</span><span style="color:#111">$EncryptedPrivileged</span><span style="color:#111">,</span> <span style="color:#111">$EncryptedUnprivileged</span><span style="color:#111">)</span> <span style="color:#111">=</span> <span style="color:#111">Get-Content</span> <span style="color:#111">-Path</span> <span style="color:#d88200">&#34;$CredentialsFilePath&#34;</span>

    <span style="color:#111">$PrivilegedPasswordSS</span> <span style="color:#111">=</span> <span style="color:#111">ConvertTo-SecureString</span> <span style="color:#111">-String</span> <span style="color:#111">$EncryptedPrivileged</span> <span style="color:#111">-SecureKey</span> <span style="color:#111">$KeySS</span>
    <span style="color:#111">$UnprivilegedPasswordSS</span> <span style="color:#111">=</span> <span style="color:#111">ConvertTo-SecureString</span> <span style="color:#111">-String</span> <span style="color:#111">$EncryptedUnprivileged</span> <span style="color:#111">-SecureKey</span> <span style="color:#111">$KeySS</span>

    <span style="color:#111">$PrivilegedCredentials</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Management</span><span style="color:#111">.</span><span style="color:#111">Automation</span><span style="color:#111">.</span><span style="color:#111">PsCredential</span><span style="color:#111">(</span><span style="color:#111">$PrivilegedCredentialsUsername</span><span style="color:#111">,</span> <span style="color:#111">$PrivilegedPasswordSS</span><span style="color:#111">)</span>
    <span style="color:#111">$UnprivilegedCredentials</span> <span style="color:#111">=</span> <span style="color:#111">New-Object</span> <span style="color:#111">System</span><span style="color:#111">.</span><span style="color:#111">Management</span><span style="color:#111">.</span><span style="color:#111">Automation</span><span style="color:#111">.</span><span style="color:#111">PsCredential</span><span style="color:#111">(</span><span style="color:#111">$UnprivilegedCredentialsUsername</span><span style="color:#111">,</span> <span style="color:#111">$UnprivilegedPasswordSS</span><span style="color:#111">)</span>
<span style="color:#111">}</span></code></pre></div>
<p>With the credentials in place, the script initiates the switching process:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e">#Switch</span>
<span style="color:#111">net</span> <span style="color:#111">use</span> <span style="color:#111">/</span><span style="color:#111">delete</span> <span style="color:#111">$NetworkShareDriveLetter</span> <span style="color:#111">/</span><span style="color:#111">y</span>
<span style="color:#111">net</span> <span style="color:#111">use</span> <span style="color:#111">/</span><span style="color:#111">delete</span> <span style="color:#111">$NetworkSharePath</span> <span style="color:#111">/</span><span style="color:#111">y</span>
<span style="color:#111">cmdkey</span> <span style="color:#111">/</span><span style="color:#111">delete</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$NetworkHost</span>
<span style="color:#111">RequestServerReset</span>
<span style="color:#00a8c8">do</span><span style="color:#111">{</span>
    <span style="color:#111">$Result</span> <span style="color:#111">=</span> <span style="color:#111">$null</span>
    <span style="color:#111">Start-Sleep</span> <span style="color:#111">-Milliseconds</span>  <span style="color:#111">500</span>
    <span style="color:#111">$Result</span><span style="color:#111">=</span> <span style="color:#111">&amp;{</span> <span style="color:#111">net</span> <span style="color:#111">use</span> <span style="color:#111">$NetworkShareDriveLetter</span> <span style="color:#111">$NetworkSharePath</span> <span style="color:#111">/</span><span style="color:#111">user</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$(</span><span style="color:#111">$PrivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">UserName</span><span style="color:#111">)</span> <span style="color:#d88200">&#34;</span><span style="color:#111">$(</span><span style="color:#111">$PrivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">GetNetworkCredential</span><span style="color:#111">().</span><span style="color:#111">Password</span><span style="color:#111">)</span><span style="color:#d88200">&#34;</span> <span style="color:#111">}</span> <span style="color:#111">*&gt;&amp;</span><span style="color:#111">1</span>
<span style="color:#111">}</span> <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#f92672">-not</span> <span style="color:#111">$Result</span><span style="color:#111">.</span><span style="color:#111">Contains</span><span style="color:#111">(</span><span style="color:#d88200">&#39;The command completed successfully.&#39;</span><span style="color:#111">))</span></code></pre></div>
<p>After the predefined time has passed, inform the user that credentials are about to be switched back:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#00a8c8">do</span> <span style="color:#111">{</span>
<span style="color:#111">Start-Sleep</span> <span style="color:#111">-Milliseconds</span>  <span style="color:#111">(</span><span style="color:#111">$SessionTimeOut</span> <span style="color:#111">*</span> <span style="color:#111">60000</span><span style="color:#111">)</span>
    <span style="color:#75715e">#$msgBoxInput = [Windows.Forms.MessageBox]::Show(&#39;Credentials are going to be switched back to unpriviledged. If you would like to continue working with admin credentials please press cancel&#39;,&#39;Credential Switching&#39;, [Windows.Forms.MessageBoxButtons]::OKCancel, [Windows.Forms.MessageBoxIcon]::Question)</span>
    <span style="color:#111">$msgBoxInput</span> <span style="color:#111">=</span> <span style="color:#111">Start-GCTimeoutDialog</span> <span style="color:#111">-Title</span> <span style="color:#d88200">&#34;Credential Switcher&#34;</span> <span style="color:#111">-Message</span> <span style="color:#d88200">&#34;Credentials are going to be switched back to unpriviledged. If you would like to continue working with privileged credentials please press Cancel.&#34;</span> <span style="color:#111">-Seconds</span> <span style="color:#111">10</span>
<span style="color:#111">}</span> <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#111">$msgBoxInput</span> <span style="color:#f92672">-eq</span> <span style="color:#d88200">&#39;Cancel&#39;</span><span style="color:#111">)</span></code></pre></div>
<p>Switch credentials back and save the credentials in Windows Credentials Vault so that they can be used next time the user restarts the connection.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># SwitchCredentials Back</span>
<span style="color:#111">net</span> <span style="color:#111">use</span> <span style="color:#111">/</span><span style="color:#111">delete</span> <span style="color:#111">$NetworkShareDriveLetter</span> <span style="color:#111">/</span><span style="color:#111">y</span>
<span style="color:#111">net</span> <span style="color:#111">use</span> <span style="color:#111">/</span><span style="color:#111">delete</span> <span style="color:#111">$NetworkSharePath</span> <span style="color:#111">/</span><span style="color:#111">y</span>
<span style="color:#111">cmdkey</span> <span style="color:#111">/</span><span style="color:#111">delete</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$NetworkHost</span>
<span style="color:#111">RequestServerReset</span>
<span style="color:#00a8c8">do</span><span style="color:#111">{</span>
    <span style="color:#111">$Result</span> <span style="color:#111">=</span> <span style="color:#111">$null</span>
    <span style="color:#111">Start-Sleep</span> <span style="color:#111">-Milliseconds</span>  <span style="color:#111">500</span>
    <span style="color:#111">$Result</span><span style="color:#111">=</span> <span style="color:#111">&amp;{</span> <span style="color:#111">net</span> <span style="color:#111">use</span> <span style="color:#111">$NetworkShareDriveLetter</span> <span style="color:#111">$NetworkSharePath</span> <span style="color:#111">/</span><span style="color:#111">user</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$(</span><span style="color:#111">$UnprivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">UserName</span><span style="color:#111">)</span> <span style="color:#d88200">&#34;</span><span style="color:#111">$(</span><span style="color:#111">$UnprivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">GetNetworkCredential</span><span style="color:#111">().</span><span style="color:#111">Password</span><span style="color:#111">)</span><span style="color:#d88200">&#34;</span> <span style="color:#111">/</span><span style="color:#111">persistent</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">yes</span><span style="color:#111">}</span> <span style="color:#111">*&gt;&amp;</span><span style="color:#111">1</span>
<span style="color:#111">}</span> <span style="color:#00a8c8">while</span> <span style="color:#111">(</span><span style="color:#f92672">-not</span> <span style="color:#111">$Result</span><span style="color:#111">.</span><span style="color:#111">Contains</span><span style="color:#111">(</span><span style="color:#d88200">&#39;The command completed successfully.&#39;</span><span style="color:#111">))</span>
<span style="color:#111">cmdkey</span> <span style="color:#111">/</span><span style="color:#111">add</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$NetworkHost</span> <span style="color:#111">/</span><span style="color:#111">user</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#111">$(</span><span style="color:#111">$UnprivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">UserName</span><span style="color:#111">)</span> <span style="color:#111">/</span><span style="color:#111">pass</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#d88200">&#34;</span><span style="color:#111">$(</span><span style="color:#111">$UnprivilegedCredentials</span><span style="color:#111">.</span><span style="color:#111">GetNetworkCredential</span><span style="color:#111">().</span><span style="color:#111">Password</span><span style="color:#111">)</span><span style="color:#d88200">&#34;</span></code></pre></div>
            </article>
          </div>
          
      <div class='entry-meta-bottom'>
        

  <div class="entry-categories"><p><span>Categories</span>
    
    <a href="/categories/cybersecurity" title="View all posts in Cybersecurity">Cybersecurity</a>
  </p>
</div>



<div class="entry-tags"><p><span>Tags</span>
  
  <a href="/tags/ransomware" title="View all posts tagged Ransomware">Ransomware</a>
  
  <a href="/tags/powershell" title="View all posts tagged PowerShell">PowerShell</a>
  

</p></div>	</div>

	
<div class="author-meta">

  <div class="author">
    	
      <img alt='Alvaro Orgaz' src="https://www.gravatar.com/avatar/97c104bc334ae27bece34791f76d41b0?s=100&d=identicon" class='avatar avatar-72 photo' height='72' width='72'>
    
    <span>
      Written by:<a href="https://www.alvaroorgaz.com/" title="Posts by Alvaro Orgaz" rel="author">Alvaro Orgaz</a> </span>
    </div>
    <div class="bio">
      
      
      <p>Alvaro Orgaz is an Information Security professional and enthusiast about Artificial Intelligence, IoT, Reverse Engineering and Ethical Hacking.</p>
      
      
	
      

    


  

<a class="linkedin" target="_blank"
href="https://www.linkedin.com/in/alvaroorgaz">
<i class="fab fa-linkedin"
title="linkedin icon"></i>
</a>









<a class="github" target="_blank"
href="https://github.com/aorgazf">
<i class="fab fa-github"
title="github icon"></i>
</a>









</div>
</div>

</div>
</div>

<section id="comments" class="comments">
  

  




</section>
</div>

 



    </div>

    <footer id="site-footer" class="site-footer" role="contentinfo">
	<h1>
    
    <a href=""> Álvaro Orgaz </a>
    
	</h1>

			
			<p class="site-description">CISSP PMP</p>
			

		<div id="menu-footer" class="menu-container menu-footer" role="navigation">
		<div class="menu">

      <ul id="menu-footer-items" class="menu-footer-items">
        
</ul>

</div>	</div>

<ul class="social-media-icons">

        

        


        

        

        

        
        <li>
        <a href="https://www.linkedin.com/in/alvaroorgaz" class="linkedin" target="_blank">
            <i class="fab fa-linkedin-in" title="linkedin"></i>
            <span class="screen-reader-text">linkedin</span>
        </a>
        </li>
        

        


        
        <li>
        <a href="https://github.com/aorgazf"  class="github" target="_blank">
            <i class="fab fa-github" title="github"></i>
            <span class="screen-reader-text">github</span>
        </a>
        </li>
        


        

        

				</ul>	<div class="design-credit">
		
		<p>&copy; 2019 Álvaro Orgaz</p>
		
		<p>Nederburg Hugo Theme by <a href="https://appernetic.io">Appernetic</a>.</p>
		
	</div>
</footer>

  </div>
  <script src="https://www.alvaroorgaz.com/js/jquery.min.js"></script>
<script src="https://www.alvaroorgaz.com/js/jquerymigrate.js"></script>
<script src="https://www.alvaroorgaz.com/js/production.min.js?v=1570385275"></script>

</body>
</html>
